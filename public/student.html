<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>生徒用ホワイトボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="/style.css" rel="stylesheet" />

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- OpenCV.js（ノート提出モード用） -->
  <script
    async
    src="https://docs.opencv.org/4.x/opencv.js"
    type="text/javascript"
  ></script>
</head>
<body class="app-root">

  <!-- 上部ツールバー（生徒用） -->
  <header class="topbar topbar-student">
    <div class="topbar-left">
      <label>
        クラスコード：
        <input id="studentClassCodeInput" type="text" placeholder="例: ABC123" />
      </label>
      <label>
        ニックネーム：
        <input id="studentNicknameInput" type="text" placeholder="名前" />
      </label>
      <button id="studentJoinBtn">参加</button>
      <span id="studentStatus" class="status-label"></span>
    </div>

    <div class="topbar-right">
      <button id="studentModeWhiteboard" class="tab-button active">
        ホワイトボード共有
      </button>
      <button id="studentModeScreen" class="tab-button">
        全画面共有
      </button>
      <button id="studentModeNotebook" class="tab-button">
        ノート提出
      </button>

      <!-- ▼ ホワイトボード保存 / 読み込み（生徒自身のノート用） -->
      <button id="studentSaveBoardBtn" class="topbar-btn">
        💾 保存…
      </button>
      <button id="studentLoadBoardBtn" class="topbar-btn">
        📂 開く…
      </button>

      <!-- PDF 出力ボタン（教員と共通の ID を使う） -->
      <button id="exportPdfBtn" class="topbar-btn">
        📄 PDF出力
      </button>
    </div>
  </header>

  <!-- ▼ ホワイトボード / 画面共有 用のレイアウト -->
  <div class="main-layout">
    <!-- 共通：左サイドのホワイトボードツール -->
    <aside class="wb-sidebar" id="wbSidebar">
      <button id="sidebarToggle" class="sidebar-toggle" title="ツールパネルを折りたたむ">
        <span class="chevron">⮜</span>
      </button>

      <section class="wb-section">
        <h3>
          <span class="section-icon">🧰</span>
          <span class="section-text">ツール</span>
        </h3>
        <div class="tool-row">
          <button data-tool="select" class="tool-button" title="選択">
            <span class="icon">🖱️</span><span class="tool-label">選択</span>
          </button>
          <button data-tool="pen" class="tool-button" title="ペン">
            <span class="icon">✏️</span><span class="tool-label">ペン</span>
          </button>
          <button data-tool="highlighter" class="tool-button" title="蛍光ペン">
            <span class="icon">🖍️</span><span class="tool-label">蛍光</span>
          </button>
          <button data-tool="eraser" class="tool-button" title="消しゴム">
            <span class="icon">🧽</span><span class="tool-label">消し</span>
          </button>
        </div>
        <div class="tool-row">
          <button data-tool="text" class="tool-button" title="テキスト">
            <span class="icon">🔤</span><span class="tool-label">テキスト</span>
          </button>
          <button data-tool="sticky" class="tool-button" title="付箋">
            <span class="icon">📝</span><span class="tool-label">付箋</span>
          </button>
        </div>
        <div class="tool-row">
          <button data-tool="shape" class="tool-button" title="図形">
            <span class="icon">⬚</span><span class="tool-label">図形</span>
          </button>
          <!-- ★ スタンプツール -->
          <button data-tool="stamp" class="tool-button" title="スタンプ">
            <span class="icon">⭐</span><span class="tool-label">スタンプ</span>
          </button>
          <!-- 削除ボタン -->
          <button
            id="deleteBtn"
            type="button"
            class="tool-button"
            title="選択中のオブジェクトを削除"
          >
            <span class="icon">🗑️</span><span class="tool-label">削除</span>
          </button>
        </div>
      </section>

      <section class="wb-section">
        <h3>
          <span class="section-icon">📄</span>
          <span class="section-text">ファイル</span>
        </h3>
        <label class="file-button">
          <span class="icon">📎</span>
          <span class="label-text">PDF読み込み</span>
          <input id="pdfInput" type="file" accept="application/pdf" hidden />
        </label>
      </section>

      <section class="wb-section">
        <h3>
          <span class="section-icon">🎨</span>
          <span class="section-text">ペン設定</span>
        </h3>
        <div class="color-row">
          <!-- 初期カラーパレット 10色 -->
          <button class="color-swatch active" data-pen-color="#111827" style="--swatch-color:#111827;"></button>
          <button class="color-swatch" data-pen-color="#ef4444" style="--swatch-color:#ef4444;"></button>
          <button class="color-swatch" data-pen-color="#f97316" style="--swatch-color:#f97316;"></button>
          <button class="color-swatch" data-pen-color="#facc15" style="--swatch-color:#facc15;"></button>
          <button class="color-swatch" data-pen-color="#22c55e" style="--swatch-color:#22c55e;"></button>
          <button class="color-swatch" data-pen-color="#0ea5e9" style="--swatch-color:#0ea5e9;"></button>
          <button class="color-swatch" data-pen-color="#6366f1" style="--swatch-color:#6366f1;"></button>
          <button class="color-swatch" data-pen-color="#a855f7" style="--swatch-color:#a855f7;"></button>
          <button class="color-swatch" data-pen-color="#ec4899" style="--swatch-color:#ec4899;"></button>
          <button class="color-swatch" data-pen-color="#6b7280" style="--swatch-color:#6b7280;"></button>
        </div>

        <div class="tool-row" style="margin-top:6px;">
          <select id="penWidthSelect">
            <option value="2">細</option>
            <option value="3" selected>普通</option>
            <option value="5">太</option>
            <option value="8">極太</option>
          </select>
        </div>
      </section>

      <section class="wb-section">
        <h3>
          <span class="section-icon">📌</span>
          <span class="section-text">付箋カラー</span>
        </h3>
        <div class="color-row">
          <button class="color-swatch" data-sticky-color="#FEF3C7" style="--swatch-color:#FEF3C7;"></button>
          <button class="color-swatch" data-sticky-color="#E0F2FE" style="--swatch-color:#E0F2FE;"></button>
          <button class="color-swatch" data-sticky-color="#DCFCE7" style="--swatch-color:#DCFCE7;"></button>
          <button class="color-swatch" data-sticky-color="#FCE7F3" style="--swatch-color:#FCE7F3;"></button>
          <button class="color-swatch" data-sticky-color="#FDE68A" style="--swatch-color:#FDE68A;"></button>
        </div>
        <p style="margin:6px 0 0; font-size:0.75rem; color:#94a3b8;">
          付箋を選択してから色をクリックすると変更されます
        </p>
      </section>

      <!-- 付箋カラーセクションのすぐ下あたりに挿入 -->
      <section class="wb-section">
        <h3>
          <span class="section-icon">📐</span>
          <span class="section-text">図形スタイル</span>
        </h3>

        <p style="margin:0 0 4px; font-size:0.75rem; color:#94a3b8;">
          図形や付箋を選択してから変更します
        </p>

        <!-- 線の色 -->
        <div style="margin-top:4px; margin-bottom:2px; font-size:0.75rem; color:#64748b;">
          線の色
        </div>
        <div class="color-row">
          <button class="color-swatch" data-shape-stroke-color="#111827" style="--swatch-color:#111827;"></button>
          <button class="color-swatch" data-shape-stroke-color="#ef4444" style="--swatch-color:#ef4444;"></button>
          <button class="color-swatch" data-shape-stroke-color="#f97316" style="--swatch-color:#f97316;"></button>
          <button class="color-swatch" data-shape-stroke-color="#facc15" style="--swatch-color:#facc15;"></button>
          <button class="color-swatch" data-shape-stroke-color="#22c55e" style="--swatch-color:#22c55e;"></button>
          <button class="color-swatch" data-shape-stroke-color="#0ea5e9" style="--swatch-color:#0ea5e9;"></button>
          <button class="color-swatch" data-shape-stroke-color="#6366f1" style="--swatch-color:#6366f1;"></button>
          <button class="color-swatch" data-shape-stroke-color="#a855f7" style="--swatch-color:#a855f7;"></button>
          <button class="color-swatch" data-shape-stroke-color="#ec4899" style="--swatch-color:#ec4899;"></button>
          <button class="color-swatch" data-shape-stroke-color="#6b7280" style="--swatch-color:#6b7280;"></button>
        </div>

        <!-- 塗りつぶし色 -->
        <div style="margin-top:8px; margin-bottom:2px; font-size:0.75rem; color:#64748b;">
          塗りつぶし
        </div>
        <div class="color-row">
          <!-- 「なし」 -->
          <button class="color-swatch" data-shape-fill-color="transparent" style="--swatch-color:#ffffff;" title="塗りつぶしなし"></button>

          <!-- 付箋と似た柔らかい色をいくつか -->
          <button class="color-swatch" data-shape-fill-color="#FEF3C7" style="--swatch-color:#FEF3C7;"></button>
          <button class="color-swatch" data-shape-fill-color="#E0F2FE" style="--swatch-color:#E0F2FE;"></button>
          <button class="color-swatch" data-shape-fill-color="#DCFCE7" style="--swatch-color:#DCFCE7;"></button>
          <button class="color-swatch" data-shape-fill-color="#FCE7F3" style="--swatch-color:#FCE7F3;"></button>
          <button class="color-swatch" data-shape-fill-color="#FDE68A" style="--swatch-color:#FDE68A;"></button>
        </div>

        <!-- 線の太さ -->
        <div style="margin-top:8px; margin-bottom:2px; font-size:0.75rem; color:#64748b;">
          線の太さ
        </div>
        <div class="tool-row">
          <select id="shapeStrokeWidthSelect">
            <option value="1">極細</option>
            <option value="2">細</option>
            <option value="3" selected>普通</option>
            <option value="5">太</option>
            <option value="8">極太</option>
          </select>
        </div>
      </section>

      <section class="wb-section">
        <h3>
          <span class="section-icon">✏️</span>
          <span class="section-text">編集</span>
        </h3>
        <div class="tool-row">
          <button id="undoBtn" class="tool-button">
            <span class="icon">↩️</span><span class="tool-label">元に戻す</span>
          </button>
          <button id="clearBtn" class="tool-button">
            <span class="icon">🗑️</span><span class="tool-label">全消去</span>
          </button>
        </div>
        <div class="tool-row">
          <button id="groupBtn" class="tool-button">
            <span class="icon">🧩</span><span class="tool-label">グループ化</span>
          </button>
          <button id="lockBtn" class="tool-button">
            <span class="icon">🔒</span><span class="tool-label">ロック</span>
          </button>
        </div>
        <div class="tool-row">
          <button id="zoomInBtn" class="tool-button">
            <span class="icon">➕</span><span class="tool-label">拡大</span>
          </button>
          <button id="zoomOutBtn" class="tool-button">
            <span class="icon">➖</span><span class="tool-label">縮小</span>
          </button>
        </div>
        <!-- 前面 / 後面移動ボタン（教員側と同様） -->
        <div class="tool-row">
          <button id="bringToFrontBtn" class="tool-button" title="前面へ移動">
            <span class="icon">⬆️</span><span class="tool-label">前面へ</span>
          </button>
          <button id="sendToBackBtn" class="tool-button" title="背面へ移動">
            <span class="icon">⬇️</span><span class="tool-label">背面へ</span>
          </button>
        </div>
      </section>
    </aside>

    <!-- 右側：ホワイトボード本体（生徒側） -->
    <main class="wb-main">
      <div id="boardContainer" class="board-container">
        <canvas id="whiteboard"></canvas>
      </div>

      <!-- 生徒側の画面共有は別で getDisplayMedia を使う（student.js 側で制御） -->
    </main>
  </div>

  <!-- ▼ ノート提出モード用レイアウト（A案：全画面に近いレイアウト） -->
  <div id="notebookLayout" class="student-notebook-layout" style="display: none;">
    <div class="student-notebook-inner">
      <div class="student-notebook-toolbar">
        <div class="student-notebook-toolbar-left">
          <span class="section-title">ノート提出（カメラ撮影）</span>
        </div>
        <div class="student-notebook-toolbar-right">
          <label>
            カメラ：
            <select id="cameraSelect" class="small-input"></select>
          </label>
          <label>
            用紙サイズ：
            <select id="paperSizeSelect" class="small-input">
              <option value="A4">A4（210×297）</option>
              <option value="B5">B5（182×257）</option>
              <option value="B4">B4（257×364）</option>
            </select>
          </label>
          <button id="startCameraBtn" class="topbar-btn">カメラ開始</button>
        </div>
      </div>

      <main class="student-notebook-content">
        <section class="video-section">
          <div class="section-title">撮影中の映像（机上のノート）</div>
          <video id="video" autoplay playsinline></video>
        </section>

        <section class="preview-section">
          <div class="section-title">
            台形補正後（送信イメージ：自動追尾＋用紙比率）
          </div>
          <canvas id="previewCanvas"></canvas>
        </section>

        <section class="feedback-section">
          <div class="section-title">教員からのフィードバック</div>
          <img id="feedbackImage" alt="フィードバック画像" />
        </section>
      </main>
    </div>
  </div>

  <!-- socket.io -->
  <script src="/socket.io/socket.io.js"></script>

  <!-- モジュール -->
  <script type="module" src="/js/student.js"></script>

  <!-- ▼ 生徒用チャットUI（右側パネル） -->
  <button id="chatToggleBtn" class="chat-toggle-btn" title="チャットを開く">
    💬
    <span id="chatNotifyDot" class="chat-notify-dot"></span>
  </button>

  <aside id="chatPanel" class="chat-panel collapsed">
    <header class="chat-panel-header">
      <h3 class="chat-title">教員とのチャット</h3>
      <div id="chatTargetArea" class="chat-target-area chat-target-area--student">
        教員との個別チャット
      </div>
      <button id="chatCloseBtn" class="chat-close-btn">×</button>
    </header>

    <div id="chatMessages" class="chat-messages"></div>

    <footer class="chat-input-area">
      <input
        id="chatInput"
        type="text"
        placeholder="メッセージを入力（ホワイトボード共有中のみ送信可）"
        autocomplete="off"
      />
      <button id="chatSendBtn">送信</button>
    </footer>
  </aside>

  <!-- ▼ スタンプ候補パレット（キャンバス上に重ねて表示） -->
  <div id="stampPalette" class="stamp-palette stamp-palette-hidden">
    <div class="stamp-palette-inner">
      <div class="stamp-palette-header">
        <span>スタンプを選択</span>
        <button id="stampPaletteCloseBtn" class="stamp-palette-close">×</button>
      </div>
      <div class="stamp-palette-grid">
        <!-- 中身は JS（board-ui.js）が wb.stampPresets から作り直します -->
      </div>
    </div>
  </div>

  <!-- ▼ 図形パレット（図形ツール用） -->
  <div id="shapePalette" class="stamp-palette stamp-palette-hidden shape-palette">
    <div class="stamp-palette-inner shape-palette-inner">
      <div class="stamp-palette-header">
        <span>図形を選択</span>
        <button id="shapePaletteCloseBtn" class="stamp-palette-close">×</button>
      </div>
      <!-- 中身（.shape-items）は board-ui.js 側で動的に生成 -->
      <div class="shape-items"></div>
    </div>
  </div>
</body>
</html>
