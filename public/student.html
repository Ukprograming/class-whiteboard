<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>生徒用ホワイトボード</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="/style.css" rel="stylesheet" />
  <!-- Google Material Icons -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- OpenCV.js（ノート提出モード用） -->
  <script async src="https://docs.opencv.org/4.x/opencv.js" type="text/javascript"></script>
</head>

<body class="app-root">

  <!-- ホワイトボード (全画面) -->
  <div id="boardContainer" class="board-container full-screen">
    <canvas id="whiteboard"></canvas>
  </div>

  <!-- ノート提出モード用レイアウト (全画面オーバーレイ) -->
  <div id="notebookLayout" class="student-notebook-layout hidden">
    <div class="student-notebook-inner">
      <div class="student-notebook-toolbar">
        <div class="student-notebook-toolbar-left">
          <span class="section-title">ノート提出（カメラ撮影）</span>
        </div>
        <div class="student-notebook-toolbar-right">
          <label>
            カメラ：
            <select id="cameraSelect" class="small-input"></select>
          </label>
          <label>
            用紙サイズ：
            <select id="paperSizeSelect" class="small-input">
              <option value="A4">A4（210×297）</option>
              <option value="B5">B5（182×257）</option>
              <option value="B4">B4（257×364）</option>
            </select>
          </label>
          <button id="startCameraBtn" class="topbar-btn">カメラ開始</button>
          <button id="notebookBackBtn" class="topbar-btn">戻る</button>
        </div>
      </div>

      <main class="student-notebook-content">
        <section class="video-section">
          <div class="section-title">撮影中の映像（机上のノート）</div>
          <video id="video" autoplay playsinline></video>
        </section>

        <section class="preview-section">
          <div class="section-title">
            台形補正後（送信イメージ：自動追尾＋用紙比率）
          </div>
          <canvas id="previewCanvas"></canvas>
        </section>

        <section class="feedback-section">
          <div class="section-title">教員からのフィードバック</div>

          <div class="feedback-viewer">
            <div class="feedback-toolbar">
              <span>先生からのフィードバック</span>
              <div class="feedback-toolbar-right">
                <button id="feedbackResetBtn" type="button" class="topbar-btn small">
                  リセット
                </button>
                <span id="feedbackZoomLabel">100%</span>
              </div>
            </div>

            <div id="feedbackViewport" class="feedback-viewport">
              <img id="feedbackImage" alt="フィードバック画像" />
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- 上部フローティングツールバー -->
  <header class="floating-topbar">
    <!-- 左側：ファイルメニュー -->
    <div class="topbar-left">
      <div class="dropdown">
        <button id="fileMenuBtn" class="icon-btn-text">
          <span class="material-symbols-rounded">menu</span>
          ファイル
        </button>
        <div id="fileMenuDropdown" class="dropdown-content hidden">
          <button id="studentSaveBoardBtn"><span class="material-symbols-rounded">save</span> 保存...</button>
          <button id="studentLoadBoardBtn"><span class="material-symbols-rounded">folder_open</span> 開く...</button>
          <button id="studentOverwriteSaveBtn"><span class="material-symbols-rounded">save</span> 上書き保存</button>
          <hr>
          <button id="exportPdfBtn"><span class="material-symbols-rounded">picture_as_pdf</span> PDF出力</button>
          <button id="exportPngBtn"><span class="material-symbols-rounded">image</span> PNG出力</button>
        </div>
      </div>
    </div>

    <!-- 中央：モード切り替え -->
    <div class="topbar-center">
      <div class="mode-switcher">
        <button id="studentModeWhiteboard" class="mode-btn active" title="ホワイトボード">
          <span class="material-symbols-rounded">edit_note</span>
        </button>
        <button id="studentModeScreen" class="mode-btn" title="全画面共有">
          <span class="material-symbols-rounded">screen_share</span>
        </button>
        <button id="studentModeNotebook" class="mode-btn" title="ノート提出">
          <span class="material-symbols-rounded">assignment</span>
        </button>
      </div>
    </div>

    <!-- 右側：チャットなど -->
    <div class="topbar-right">
      <button id="chatToggleBtn" class="icon-btn" title="チャット">
        <span class="material-symbols-rounded">chat</span>
        <span id="chatNotifyDot" class="chat-notify-dot"></span>
      </button>
    </div>
  </header>

  <!-- 左サイド フローティングツールバー (折りたたみ可) -->
  <aside id="wbSidebar" class="floating-sidebar">
    <div class="sidebar-content">
      <!-- ツール切り替え -->
      <div class="tool-group">
        <button data-tool="select" class="tool-btn active" title="選択">
          <span class="material-symbols-rounded">arrow_selector_tool</span>
        </button>
        <button data-tool="pen" class="tool-btn" title="ペン">
          <span class="material-symbols-rounded">edit</span>
        </button>
        <button data-tool="highlighter" class="tool-btn" title="蛍光ペン">
          <span class="material-symbols-rounded">ink_highlighter</span>
        </button>
        <button data-tool="eraser" class="tool-btn" title="消しゴム">
          <span class="material-symbols-rounded">ink_eraser</span>
        </button>
      </div>

      <div class="divider"></div>

      <div class="tool-group">
        <button data-tool="sticky" class="tool-btn" title="付箋">
          <span class="material-symbols-rounded">sticky_note_2</span>
        </button>
        <button data-tool="text" class="tool-btn" title="テキスト">
          <span class="material-symbols-rounded">title</span>
        </button>
        <button data-tool="shape" class="tool-btn" title="図形">
          <span class="material-symbols-rounded">shapes</span>
        </button>
        <button data-tool="stamp" class="tool-btn" title="スタンプ">
          <span class="material-symbols-rounded">add_reaction</span>
        </button>
      </div>

      <div class="divider"></div>

      <div class="tool-group">
        <label for="pdfInput" class="tool-btn" title="PDF読み込み">
          <span class="material-symbols-rounded">picture_as_pdf</span>
          <input id="pdfInput" type="file" accept="application/pdf" hidden />
        </label>
      </div>
    </div>

    <!-- 折りたたみボタン -->
    <button id="sidebarToggle" class="sidebar-toggle-btn">
      <span class="material-symbols-rounded">chevron_left</span>
    </button>
  </aside>

  <!-- 画面右下のツール (Undo/Redo, Zoom) -->
  <div class="floating-bottom-right">
    <div class="edit-tools">
      <button id="undoBtn" class="icon-btn" title="元に戻す"><span class="material-symbols-rounded">undo</span></button>
      <button id="deleteBtn" class="icon-btn" title="削除"><span class="material-symbols-rounded">delete</span></button>
      <div class="divider-vertical"></div>
      <button id="groupBtn" class="icon-btn" title="グループ化"><span
          class="material-symbols-rounded">group_work</span></button>
      <button id="lockBtn" class="icon-btn" title="ロック"><span class="material-symbols-rounded">lock</span></button>
      <div class="divider-vertical"></div>
      <button id="bringToFrontBtn" class="icon-btn" title="前面へ"><span
          class="material-symbols-rounded">flip_to_front</span></button>
      <button id="sendToBackBtn" class="icon-btn" title="背面へ"><span
          class="material-symbols-rounded">flip_to_back</span></button>
    </div>

    <div class="zoom-controls">
      <button id="zoomOutBtn" class="icon-btn"><span class="material-symbols-rounded">remove</span></button>
      <span id="zoomLevel">100%</span>
      <button id="zoomInBtn" class="icon-btn"><span class="material-symbols-rounded">add</span></button>
    </div>
  </div>

  <!-- チャットパネル (右側スライドイン) -->
  <aside id="chatPanel" class="chat-panel collapsed">
    <header class="chat-panel-header">
      <h3 class="chat-title">教員とのチャット</h3>
      <button id="chatCloseBtn" class="icon-btn-sm"><span class="material-symbols-rounded">close</span></button>
    </header>
    <div class="chat-target-area chat-target-area--student">
      教員との個別チャット
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <footer class="chat-input-area">
      <input id="chatInput" type="text" placeholder="メッセージ..." autocomplete="off" />
      <button id="chatSendBtn" class="icon-btn-primary"><span class="material-symbols-rounded">send</span></button>
    </footer>
  </aside>

  <!-- コンテキストメニュー (画面中央下に配置) -->
  <div id="contextMenu" class="context-menu hidden">
    <!-- ペン設定 -->
    <div id="penSettings" class="context-section hidden">
      <div class="color-palette">
        <button class="color-dot active" data-pen-color="#111827" style="--c:#111827"></button>
        <button class="color-dot" data-pen-color="#ef4444" style="--c:#ef4444"></button>
        <button class="color-dot" data-pen-color="#f97316" style="--c:#f97316"></button>
        <button class="color-dot" data-pen-color="#facc15" style="--c:#facc15"></button>
        <button class="color-dot" data-pen-color="#22c55e" style="--c:#22c55e"></button>
        <button class="color-dot" data-pen-color="#0ea5e9" style="--c:#0ea5e9"></button>
        <button class="color-dot" data-pen-color="#6366f1" style="--c:#6366f1"></button>
        <button class="color-dot" data-pen-color="#a855f7" style="--c:#a855f7"></button>
      </div>
      <div class="width-slider">
        <select id="penWidthSelect" class="simple-select">
          <option value="2">細</option>
          <option value="3" selected>普通</option>
          <option value="5">太</option>
          <option value="8">極太</option>
        </select>
      </div>
    </div>

    <!-- 付箋設定 -->
    <div id="stickySettings" class="context-section hidden">
      <div class="color-palette">
        <button class="color-dot" data-sticky-color="#FEF3C7" style="--c:#FEF3C7"></button>
        <button class="color-dot" data-sticky-color="#E0F2FE" style="--c:#E0F2FE"></button>
        <button class="color-dot" data-sticky-color="#DCFCE7" style="--c:#DCFCE7"></button>
        <button class="color-dot" data-sticky-color="#FCE7F3" style="--c:#FCE7F3"></button>
        <button class="color-dot" data-sticky-color="#FDE68A" style="--c:#FDE68A"></button>
      </div>
    </div>

    <!-- 図形設定 -->
    <div id="shapeSettings" class="context-section hidden">
      <div class="setting-row">
        <span class="label">線</span>
        <div class="color-palette mini">
          <button class="color-dot" data-shape-stroke-color="#111827" style="--c:#111827"></button>
          <button class="color-dot" data-shape-stroke-color="#ef4444" style="--c:#ef4444"></button>
          <button class="color-dot" data-shape-stroke-color="#22c55e" style="--c:#22c55e"></button>
          <button class="color-dot" data-shape-stroke-color="#0ea5e9" style="--c:#0ea5e9"></button>
        </div>
      </div>
      <div class="setting-row">
        <span class="label">塗</span>
        <div class="color-palette mini">
          <button class="color-dot" data-shape-fill-color="transparent" style="--c:#fff; border:1px dashed #ccc"
            title="なし"></button>
          <button class="color-dot" data-shape-fill-color="#FEF3C7" style="--c:#FEF3C7"></button>
          <button class="color-dot" data-shape-fill-color="#E0F2FE" style="--c:#E0F2FE"></button>
          <button class="color-dot" data-shape-fill-color="#DCFCE7" style="--c:#DCFCE7"></button>
        </div>
      </div>
    </div>
  </div>

  <!-- ▼ テキストボックス設定バー（画面下中央） ▼ -->
  <div id="textSettings" class="hidden">
    <!-- フォントサイズ -->
    <div class="ts-group">
      <span class="ts-label">サイズ</span>
      <select id="textFontSizeSelect">
        <option value="12">12</option>
        <option value="14">14</option>
        <option value="16" selected>16</option>
        <option value="20">20</option>
        <option value="24">24</option>
        <option value="32">32</option>
      </select>
    </div>

    <span class="ts-separator"></span>

    <!-- フォントファミリ -->
    <div class="ts-group">
      <span class="ts-label">フォント</span>
      <select id="textFontFamilySelect">
        <option value="system-ui" selected>標準</option>
        <option value="'Meiryo', 'メイリオ', sans-serif">メイリオ</option>
        <option value="'Yu Gothic UI', '游ゴシック体', 'YuGothic', sans-serif">ゴシック</option>
        <option value="'MS Mincho', 'ヒラギノ明朝 ProN', serif">明朝</option>
      </select>
    </div>

    <span class="ts-separator"></span>

    <!-- 太字 -->
    <div class="ts-group">
      <button id="textBoldToggle" class="ts-icon-button" type="button" title="太字">
        <span class="material-symbols-rounded">format_bold</span>
      </button>
    </div>

    <span class="ts-separator"></span>

    <!-- 文字色 -->
    <div class="ts-group ts-color-group">
      <button class="ts-color-dot is-active" data-text-color="#111827" type="button"></button>
      <button class="ts-color-dot" data-text-color="#f97316" type="button"></button>
      <button class="ts-color-dot" data-text-color="#ef4444" type="button"></button>
      <button class="ts-color-dot" data-text-color="#0ea5e9" type="button"></button>
    </div>

    <span class="ts-separator"></span>

    <!-- 左右揃え -->
    <div class="ts-group ts-align-group">
      <button class="ts-icon-button is-active" data-text-align="left" type="button" title="左揃え">
        <span class="material-symbols-rounded">format_align_left</span>
      </button>
      <button class="ts-icon-button" data-text-align="center" type="button" title="中央揃え">
        <span class="material-symbols-rounded">format_align_center</span>
      </button>
      <button class="ts-icon-button" data-text-align="right" type="button" title="右揃え">
        <span class="material-symbols-rounded">format_align_right</span>
      </button>
    </div>
  </div>
  <!-- ▲ テキストボックス設定バー ▲ -->

  <!-- スタンプパレット -->
  <div id="stampPalette" class="floating-palette hidden">
    <div class="palette-header">
      <span>スタンプ</span>
      <button id="stampPaletteCloseBtn" class="icon-btn-sm"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="stamp-palette-grid">
      <!-- JSで生成 -->
    </div>
  </div>

  <!-- 図形パレット -->
  <div id="shapePalette" class="floating-palette hidden">
    <div class="palette-header">
      <span>図形</span>
      <button id="shapePaletteCloseBtn" class="icon-btn-sm"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="shape-items"></div>
  </div>

  <!-- ログインオーバーレイ -->
  <div id="studentLoginOverlay" class="login-overlay">
    <div class="login-box">
      <h2>生徒用ホワイトボード ログイン</h2>
      <form id="studentLoginForm">
        <label>
          クラスコード
          <input id="loginClassCode" type="text" placeholder="例: ABC123" required />
        </label>
        <label>
          ニックネーム
          <input id="loginNickname" type="text" placeholder="名前" required />
        </label>
        <button type="submit">参加する</button>
      </form>
    </div>
  </div>

  <!-- socket.io -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- モジュール -->
  <script type="module" src="/js/student.js"></script>

</body>

</html>