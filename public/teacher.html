<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <title>教員用ホワイトボード＋ノート確認</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link href="/style.css" rel="stylesheet" />
  <!-- Google Material Icons -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

  <!-- pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body class="app-root">

  <!-- ホワイトボード (全画面) -->
  <div id="boardContainer" class="board-container full-screen">
    <canvas id="whiteboard"></canvas>
  </div>

  <!-- 生徒画面確認ビュー (全画面オーバーレイ) -->
  <div id="studentViewContainer" class="student-view full-screen hidden">
    <div class="view-header">
      <h2>生徒画面確認</h2>
      <p id="studentsInfo" class="students-info">接続中の生徒: 0人</p>
    </div>
    <div id="tileGrid" class="tile-grid">
      <!-- teacher.js が .tile を追加 -->
    </div>
  </div>

  <!-- ノート確認ビュー (全画面オーバーレイ) -->
  <div id="notebookViewContainer" class="notebook-view full-screen hidden">
    <div class="view-header">
      <h2>ノート確認</h2>
      <p id="notebookInfo" class="students-info">ノート提出中の生徒: 0人</p>
    </div>
    <div id="notebookStudentGrid" class="student-grid">
      <!-- teacher.js がノート用タイルを追加 -->
    </div>
  </div>

  <!-- 上部フローティングツールバー -->
  <header class="floating-topbar">
    <!-- 左側：ファイルメニュー -->
    <div class="topbar-left">
      <div class="dropdown">
        <button id="fileMenuBtn" class="icon-btn-text">
          <span class="material-symbols-rounded">menu</span>
          ファイル
        </button>
        <div id="fileMenuDropdown" class="dropdown-content">
          <button id="teacherOpenSaveDialogBtn"><span class="material-symbols-rounded">save</span> 保存...</button>
          <button id="teacherOverwriteSaveBtn" class="topbar-btn">上書き保存</button>
          <button id="teacherOpenLoadDialogBtn"><span class="material-symbols-rounded">folder_open</span> 開く...</button>
          <hr>
          <button id="exportPdfBtn"><span class="material-symbols-rounded">picture_as_pdf</span> PDF出力</button>
          <button id="exportPngBtn"><span class="material-symbols-rounded">image</span> PNG出力</button>
          <button id="leaveClassBtn">退室</button>
        </div>
      </div>
    </div>

    <!-- 中央：モード切り替え -->
    <div class="topbar-center">
      <div class="mode-switcher">
        <button id="teacherModeWhiteboard" class="mode-btn active" title="ホワイトボード">
          <span class="material-symbols-rounded">edit_note</span>
        </button>
        <button id="teacherModeStudentView" class="mode-btn" title="生徒画面確認">
          <span class="material-symbols-rounded">grid_view</span>
        </button>
        <!-- ノート確認は一旦非表示または必要なら追加 -->
        <!-- <button id="teacherModeNotebook" class="mode-btn" title="ノート確認"><span class="material-symbols-rounded">assignment</span></button> -->
      </div>
    </div>

    <!-- 右側：チャットなど -->
    <div class="topbar-right">
      <button id="chatToggleBtn" class="icon-btn" title="チャット">
        <span class="material-symbols-rounded">chat</span>
        <span id="chatNotifyDot" class="chat-notify-dot"></span>
      </button>
    </div>
  </header>

  <!-- 左サイド フローティングツールバー (折りたたみ可) -->
  <aside id="wbSidebar" class="floating-sidebar">
    <div class="sidebar-content">
      <!-- ツール切り替え -->
      <div class="tool-group">
        <button data-tool="select" class="tool-btn active" title="選択">
          <span class="material-symbols-rounded">arrow_selector_tool</span>
        </button>
        <button data-tool="pen" class="tool-btn" title="ペン">
          <span class="material-symbols-rounded">edit</span>
        </button>
        <button data-tool="highlighter" class="tool-btn" title="蛍光ペン">
          <span class="material-symbols-rounded">ink_highlighter</span>
        </button>
        <button data-tool="eraser" class="tool-btn" title="消しゴム">
          <span class="material-symbols-rounded">ink_eraser</span>
        </button>
      </div>

      <div class="divider"></div>

      <div class="tool-group">
        <button data-tool="sticky" class="tool-btn" title="付箋">
          <span class="material-symbols-rounded">sticky_note_2</span>
        </button>
        <button data-tool="text" class="tool-btn" title="テキスト">
          <span class="material-symbols-rounded">title</span>
        </button>
        <button data-tool="shape" class="tool-btn" title="図形">
          <span class="material-symbols-rounded">shapes</span>
        </button>
        <button data-tool="stamp" class="tool-btn" title="スタンプ">
          <span class="material-symbols-rounded">add_reaction</span>
        </button>
      </div>

      <div class="divider"></div>

      <div class="tool-group">
        <label for="pdfInput" class="tool-btn" title="PDF読み込み">
          <span class="material-symbols-rounded">picture_as_pdf</span>
          <input id="pdfInput" type="file" accept="application/pdf" hidden />
        </label>
      </div>
    </div>

    <!-- 折りたたみボタン -->
    <button id="sidebarToggle" class="sidebar-toggle-btn">
      <span class="material-symbols-rounded">chevron_left</span>
    </button>

    <!-- コンテキストメニュー (ツールの横に表示) -->
    <div id="contextMenu" class="context-menu hidden">
      <!-- ペン設定 -->
      <div id="penSettings" class="context-section hidden">
        <div class="color-palette">
          <button class="color-dot active" data-pen-color="#111827" style="--c:#111827"></button>
          <button class="color-dot" data-pen-color="#ef4444" style="--c:#ef4444"></button>
          <button class="color-dot" data-pen-color="#f97316" style="--c:#f97316"></button>
          <button class="color-dot" data-pen-color="#facc15" style="--c:#facc15"></button>
          <button class="color-dot" data-pen-color="#22c55e" style="--c:#22c55e"></button>
          <button class="color-dot" data-pen-color="#0ea5e9" style="--c:#0ea5e9"></button>
          <button class="color-dot" data-pen-color="#6366f1" style="--c:#6366f1"></button>
          <button class="color-dot" data-pen-color="#a855f7" style="--c:#a855f7"></button>
        </div>
        <div class="width-slider">
          <!-- シンプルにセレクトボックスで実装 -->
          <select id="penWidthSelect" class="simple-select">
            <option value="2">細</option>
            <option value="3" selected>普通</option>
            <option value="5">太</option>
            <option value="8">極太</option>
          </select>
        </div>
      </div>

      <!-- 付箋設定 -->
      <div id="stickySettings" class="context-section hidden">
        <div class="color-palette">
          <button class="color-dot" data-sticky-color="#FEF3C7" style="--c:#FEF3C7"></button>
          <button class="color-dot" data-sticky-color="#E0F2FE" style="--c:#E0F2FE"></button>
          <button class="color-dot" data-sticky-color="#DCFCE7" style="--c:#DCFCE7"></button>
          <button class="color-dot" data-sticky-color="#FCE7F3" style="--c:#FCE7F3"></button>
          <button class="color-dot" data-sticky-color="#FDE68A" style="--c:#FDE68A"></button>
        </div>
      </div>

      <!-- 図形設定 -->
      <div id="shapeSettings" class="context-section hidden">
        <div class="setting-row">
          <span class="label">線</span>
          <div class="color-palette mini">
            <button class="color-dot" data-shape-stroke-color="#111827" style="--c:#111827"></button>
            <button class="color-dot" data-shape-stroke-color="#ef4444" style="--c:#ef4444"></button>
            <button class="color-dot" data-shape-stroke-color="#22c55e" style="--c:#22c55e"></button>
            <button class="color-dot" data-shape-stroke-color="#0ea5e9" style="--c:#0ea5e9"></button>
          </div>
        </div>
        <div class="setting-row">
          <span class="label">塗</span>
          <div class="color-palette mini">
            <button class="color-dot" data-shape-fill-color="transparent" style="--c:#fff; border:1px dashed #ccc"
              title="なし"></button>
            <button class="color-dot" data-shape-fill-color="#FEF3C7" style="--c:#FEF3C7"></button>
            <button class="color-dot" data-shape-fill-color="#E0F2FE" style="--c:#E0F2FE"></button>
            <button class="color-dot" data-shape-fill-color="#DCFCE7" style="--c:#DCFCE7"></button>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <!-- ▼ テキストボックス設定バー（画面下中央） ▼ -->
  <div id="textSettings" class="hidden">
    <!-- フォントサイズ -->
    <div class="ts-group">
      <span class="ts-label">サイズ</span>
      <select id="textFontSizeSelect">
        <option value="12">12</option>
        <option value="14">14</option>
        <option value="16" selected>16</option>
        <option value="20">20</option>
        <option value="24">24</option>
        <option value="32">32</option>
      </select>
    </div>

    <span class="ts-separator"></span>

    <!-- フォントファミリ -->
    <div class="ts-group">
      <span class="ts-label">フォント</span>
      <select id="textFontFamilySelect">
        <option value="system-ui" selected>標準</option>
        <option value="'Meiryo', 'メイリオ', sans-serif">メイリオ</option>
        <option value="'Yu Gothic UI', '游ゴシック体', 'YuGothic', sans-serif">ゴシック</option>
        <option value="'MS Mincho', 'ヒラギノ明朝 ProN', serif">明朝</option>
      </select>
    </div>

    <span class="ts-separator"></span>

    <!-- 太字 -->
    <div class="ts-group">
      <button id="textBoldToggle" class="ts-icon-button" type="button" title="太字">
        <span class="material-symbols-rounded">format_bold</span>
      </button>
    </div>

    <span class="ts-separator"></span>

    <!-- 文字色 -->
    <div class="ts-group ts-color-group">
      <button class="ts-color-dot is-active" data-text-color="#111827" type="button"></button>
      <button class="ts-color-dot" data-text-color="#f97316" type="button"></button>
      <button class="ts-color-dot" data-text-color="#ef4444" type="button"></button>
      <button class="ts-color-dot" data-text-color="#0ea5e9" type="button"></button>
    </div>

    <span class="ts-separator"></span>

    <!-- 左右揃え -->
    <div class="ts-group ts-align-group">
      <button class="ts-icon-button is-active" data-text-align="left" type="button" title="左揃え">
        <span class="material-symbols-rounded">format_align_left</span>
      </button>
      <button class="ts-icon-button" data-text-align="center" type="button" title="中央揃え">
        <span class="material-symbols-rounded">format_align_center</span>
      </button>
      <button class="ts-icon-button" data-text-align="right" type="button" title="右揃え">
        <span class="material-symbols-rounded">format_align_right</span>
      </button>
    </div>
  </div>
  <!-- ▲ テキストボックス設定バー ▲ -->

  <!-- 右下 フローティングズーム & 編集ツール -->
  <div class="floating-bottom-right">
    <div class="edit-tools">
      <button id="undoBtn" class="icon-btn" title="元に戻す"><span class="material-symbols-rounded">undo</span></button>
      <button id="clearBtn" class="icon-btn" title="全消去"><span class="material-symbols-rounded">delete</span></button>
      <div class="divider-vertical"></div>
      <button id="groupBtn" class="icon-btn" title="グループ化"><span
          class="material-symbols-rounded">group_work</span></button>
      <button id="lockBtn" class="icon-btn" title="ロック"><span class="material-symbols-rounded">lock</span></button>
      <div class="divider-vertical"></div>
      <button id="bringToFrontBtn" class="icon-btn" title="前面へ"><span
          class="material-symbols-rounded">flip_to_front</span></button>
      <button id="sendToBackBtn" class="icon-btn" title="背面へ"><span
          class="material-symbols-rounded">flip_to_back</span></button>
    </div>

    <div class="zoom-controls">
      <button id="zoomOutBtn" class="icon-btn"><span class="material-symbols-rounded">remove</span></button>
      <span id="zoomLevel">100%</span>
      <button id="zoomInBtn" class="icon-btn"><span class="material-symbols-rounded">add</span></button>
    </div>
  </div>

  <!-- チャットパネル (右側スライドイン) -->
  <aside id="chatPanel" class="chat-panel collapsed">
    <header class="chat-panel-header">
      <h3 class="chat-title">クラスチャット</h3>
      <button id="chatCloseBtn" class="icon-btn-sm"><span class="material-symbols-rounded">close</span></button>
    </header>
    <div class="chat-target-area">
      <label>宛先: <select id="chatTargetSelect">
          <option value="">生徒を選択</option>
        </select></label>
    </div>
    <div id="chatMessages" class="chat-messages"></div>
    <footer class="chat-input-area">
      <input id="chatInput" type="text" placeholder="メッセージ..." autocomplete="off" />
      <button id="chatSendBtn" class="icon-btn-primary"><span class="material-symbols-rounded">send</span></button>
    </footer>
  </aside>

  <!-- スタンプパレット -->
  <div id="stampPalette" class="floating-palette hidden">
    <div class="palette-header">
      <span>スタンプ</span>
      <button id="stampPaletteCloseBtn" class="icon-btn-sm"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="stamp-palette-grid">
      <!-- JSで生成 -->
    </div>
  </div>

  <!-- 図形パレット -->
  <div id="shapePalette" class="floating-palette hidden">
    <div class="palette-header">
      <span>図形</span>
      <button id="shapePaletteCloseBtn" class="icon-btn-sm"><span class="material-symbols-rounded">close</span></button>
    </div>
    <div class="shape-items">
      <!-- JSで生成 -->
    </div>
  </div>

  <!-- ノート個別フィードバック用モーダル -->
  <div id="feedbackModalBackdrop" class="modal-backdrop" style="display: none;">
    <div class="modal modal-notebook">
      <div class="modal-header">
        <div><span id="modalStudentLabel">生徒：</span></div>
        <div class="modal-header-controls">
          <input id="penColorInput" class="small-input" type="color" value="#ff0000" />
          <input id="penWidthInput" class="small-input" type="number" value="3" min="1" max="20" />px
          <button id="eraserToggleBtn" class="share-off">消しゴムOFF</button>
          <button id="clearAnnotationBtn" class="share-off">クリア</button>
          <button id="shareToggleBtn" class="share-off">共有開始</button>
          <button id="feedbackModalCloseBtn" class="close-btn">閉じる</button>
        </div>
      </div>
      <div class="modal-body">
        <canvas id="feedbackCanvas"></canvas>
      </div>
    </div>
  </div>

  <!-- 生徒画面拡大モーダル -->
  <div id="studentModalBackdrop" class="student-modal-backdrop">
    <div class="student-modal-frame">
      <!-- ★ ここにタイトルバーを移動 -->
      <div class="modal-header-overlay">
        <div id="studentModalTitle" class="modal-title">生徒の画面</div>
        <button id="modalShareToStudentBtn" class="share-btn">
          生徒に送信
        </button>
        <button id="studentModalCloseBtn" class="icon-btn">
          <span class="material-symbols-rounded">close</span>
        </button>
      </div>

      <!-- 左のツールサイドバー -->
      <div id="studentModalSidebar" class="modal-sidebar">
        <div class="sidebar-content">
          <!-- ツールボタン -->
          <!-- ★ 移動ボタンは不要なので削除済み -->
          <button id="modalToolPen" class="wb-btn" data-tool="pen">ペン</button>
          <button id="modalToolHighlighter" class="wb-btn" data-tool="highlighter">蛍光ペン</button>
          <button id="modalToolEraser" class="wb-btn" data-tool="eraser">消しゴム</button>

          <div class="setting-row">
            <span class="label">色</span>
            <input id="modalPenColor" type="color" value="#111827" />
          </div>
        </div>
      </div>

      <!-- 右側：ホワイトボード表示エリア -->
      <div id="studentModalBoardContainer" class="modal-board-container">
        <canvas id="studentModalCanvas"></canvas>
      </div>
    </div>
  </div>


  <!-- socket.io -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- モジュール -->
  <script type="module" src="/js/teacher.js"></script>
</body>

</html>